/*
 * steadstateOnePhasePipeFlowSolver.java
 *
 * Created on 17. januar 2001, 21:10
 */

package fluidMechanics.flowSolver.twoPhaseFlowSolver.stirredCellSolver;

import javax.swing.JOptionPane;
import MathLib.JamaLinAlg.*;
import MathLib.nonLinearSolver.*;
import java.io.*;
import fluidMechanics.flowSystem.*;
import thermodynamicOperations.*;
import thermo.system.*;
import thermo.component.*;
import MathLib.generalMath.*;
import fluidMechanics.flowSystem.twoPhaseFlowSystem.twoPhasePipeFlowSystem.*;
import fluidMechanics.flowSolver.twoPhaseFlowSolver.twoPhasePipeFlowSolver.*;
/**
 *
 * @author  Even Solbraa
 * @version
 */
public class StirredCellSolver extends TwoPhasePipeFlowSolver implements thermo.ThermodynamicConstantsInterface{
    Matrix diffMatrix;
    double dn[][];
    int iter=0;
    Matrix[] diff4Matrix;
    double xNew[][][];
    protected double oldMass[][];
    protected double oldComp[][];
    protected double oldDensity[][];
    protected double oldVelocity[][];
    protected double oldComposition[][][];
    protected double oldInternalEnergy[][];
    protected double oldImpuls[][];
    protected double oldEnergy[][];
    /** Creates new steadstateOnePhasePipeFlowSolver */
    public StirredCellSolver() {
    }
    
    /** Creates new nonlin */
    public StirredCellSolver(FlowSystemInterface pipe, double length, int nodes) {
        super(pipe, length, nodes);
    }
    
    public StirredCellSolver(FlowSystemInterface pipe, double length, int nodes, boolean dynamic){
        super(pipe, length, nodes);
        this.dynamic = dynamic;
        oldMass = new double[2][nodes];
        oldComp = new double[2][nodes];
        oldImpuls = new double[2][nodes];
        diff4Matrix = new Matrix[pipe.getNode(0).getBulkSystem().getPhases()[0].getNumberOfComponents()];
        oldEnergy = new double[2][nodes];
        oldVelocity = new double[2][nodes];
        oldDensity = new double[2][nodes];
        oldInternalEnergy = new double[2][nodes];
        oldComposition = new double[2][pipe.getNode(0).getBulkSystem().getPhases()[0].getNumberOfComponents()][nodes];
        numberOfVelocityNodes = nodes;
    }
    
    public Object clone(){
        TwoPhaseFixedStaggeredGridSolver clonedSystem = null;
        try{
            clonedSystem = (TwoPhaseFixedStaggeredGridSolver) super.clone();
        }
        catch(Exception e) {
            e.printStackTrace(System.err);
        }
        return clonedSystem;
    }
    
    
    public void initProfiles(){
        double err=0, oldPres=0, oldTemp=0, dpdx=0;
        
        SystemInterface tempSyst = (SystemInterface) pipe.getNode(0).getBulkSystem().clone();
        ThermodynamicOperations testOps = new ThermodynamicOperations(tempSyst);
        testOps.TPflash();
        testOps.displayResult();
        
        double[][][] molDiff = new double[numberOfNodes][2][pipe.getNode(0).getBulkSystem().getPhases()[0].getNumberOfComponents()];
        pipe.getNode(0).init();
        pipe.getNode(0).calcFluxes();
        
        for(int i = 1;i<numberOfNodes-1;i++){
            pipe.getNode(i).init();
            pipe.getNode(i).calcFluxes();
            
            for(int componentNumber=0;componentNumber<pipe.getNode(0).getBulkSystem().getPhases()[0].getNumberOfComponents();componentNumber++){
                double liquidMolarRate =  pipe.getNode(i).getFluidBoundary().getInterphaseMolarFlux(componentNumber) * pipe.getNode(i).getInterphaseContactLength(0)*pipe.getNode(i).getGeometry().getNodeLength();//*(pipe.getNode(i).getGeometry().getNodeLength()/pipe.getNode(i).getVelocity(1));
                double gasMolarRate =  - pipe.getNode(i).getFluidBoundary().getInterphaseMolarFlux(componentNumber) * pipe.getNode(i).getInterphaseContactLength(0)*pipe.getNode(i).getGeometry().getNodeLength();//*(pipe.getNode(i).getGeometry().getNodeLength()/pipe.getNode(i).getVelocity(0));
                double liquidHeatRate = pipe.getNode(i).getFluidBoundary().getInterphaseHeatFlux()*pipe.getNode(i).getInterphaseContactLength(0)*pipe.getNode(i).getGeometry().getNodeLength();
                double gasHeatRate = - pipe.getNode(i).getFluidBoundary().getInterphaseHeatFlux()*pipe.getNode(i).getInterphaseContactLength(0)*pipe.getNode(i).getGeometry().getNodeLength();
                
                double liquid_dT = - liquidHeatRate/pipe.getNode(i).getBulkSystem().getPhase(1).getCp();
                double gas_dT    = gasHeatRate/pipe.getNode(i).getBulkSystem().getPhase(0).getCp();
                
                molDiff[i][0][componentNumber] = molDiff[i-1][0][componentNumber] + gasMolarRate;
                molDiff[i][1][componentNumber] = molDiff[i-1][1][componentNumber] + liquidMolarRate;
                
                pipe.getNode(i+1).getBulkSystem().getPhases()[0].addMoles(componentNumber, molDiff[i][0][componentNumber]);
                pipe.getNode(i+1).getBulkSystem().getPhases()[1].addMoles(componentNumber, molDiff[i][1][componentNumber]);
                
                pipe.getNode(i+1).getBulkSystem().getPhase(0).setTemperature(pipe.getNode(i).getBulkSystem().getPhase(0).getTemperature() + gas_dT);
                pipe.getNode(i+1).getBulkSystem().getPhase(1).setTemperature(pipe.getNode(i).getBulkSystem().getPhase(1).getTemperature() + liquid_dT);
            }
            
            pipe.getNode(i+1).getBulkSystem().initBeta();
            pipe.getNode(i+1).getBulkSystem().init_x_y();
            pipe.getNode(i+1).initFlowCalc();
            
            System.out.println("x " + pipe.getNode(i-1).getBulkSystem().getPhases()[1].getComponents()[0].getx());
            System.out.println("x " + pipe.getNode(i-1).getBulkSystem().getPhases()[1].getComponents()[1].getx());
            System.out.println("y " + pipe.getNode(i-1).getBulkSystem().getPhases()[0].getComponents()[0].getx());
            System.out.println("y " + pipe.getNode(i-1).getBulkSystem().getPhases()[0].getComponents()[1].getx());
        }
        pipe.getNode(numberOfNodes-1).init();
        pipe.getNode(numberOfNodes-1).calcFluxes();
        this.initNodes();
        System.out.println("finisched initializing....");
    }
    
    public void initMatrix(){
        for(int i=0;i<numberOfNodes;i++){
            pipe.getNode(i).init();
            double enthalpy0 = pipe.getNode(i).getBulkSystem().getPhases()[0].getEnthalpy()/pipe.getNode(i).getBulkSystem().getPhases()[0].getNumberOfMolesInPhase()/pipe.getNode(i).getBulkSystem().getPhases()[0].getMolarMass();
            double enthalpy1 = pipe.getNode(i).getBulkSystem().getPhases()[1].getEnthalpy()/pipe.getNode(i).getBulkSystem().getPhases()[1].getNumberOfMolesInPhase()/pipe.getNode(i).getBulkSystem().getPhases()[1].getMolarMass();
            
            solMatrix[0].set(i,0,  pipe.getNode(i).getVelocityIn(0).doubleValue());
            solMatrix[1].set(i,0,  pipe.getNode(i).getVelocityIn(1).doubleValue());
            
            sol3Matrix[0].set(i,0,enthalpy0);
            sol3Matrix[1].set(i,0,enthalpy1);
            
            solPhaseConsMatrix[0].set(i,0,pipe.getNode(i).getBulkSystem().getPhases()[0].getPhysicalProperties().getDensity());
            solPhaseConsMatrix[1].set(i,0,pipe.getNode(i).getPhaseFraction(1));
            
            for(int phase=0;phase<2;phase++){
                for(int j=0;j<pipe.getNode(i).getBulkSystem().getPhases()[0].getNumberOfComponents();j++){
                    solMolFracMatrix[phase][j].set(i,0,pipe.getNode(i).getBulkSystem().getPhases()[phase].getComponents()[j].getx()*pipe.getNode(i).getBulkSystem().getPhases()[phase].getComponents()[j].getMolarMass()/pipe.getNode(i).getBulkSystem().getPhases()[phase].getMolarMass());
                }
            }
        }
    }
    
    public void initPressure(int phase){
        for(int i = 0;i<numberOfNodes;i++){
            pipe.getNode(i).init();
            pipe.getNode(i).getBulkSystem().setPressure(0.8*pipe.getNode(i).getBulkSystem().getPhases()[phase].getdPdrho()*diffMatrix.get(i,0)*1e-5 + pipe.getNode(i).getBulkSystem().getPressure());
            pipe.getNode(i).init();
        }
    }
    
    
    public void initVelocity(int phase){
        for(int i = 0;i<numberOfNodes;i++){
            pipe.getNode(i).setVelocityIn(phase, pipe.getNode(i).getVelocityIn(phase).doubleValue() + 0.8*(solMatrix[phase].get(i,0)-pipe.getNode(i).getVelocityIn(phase).doubleValue()));
        }
        
        for(int i = 0;i<numberOfNodes;i++){
            double meanVelocity = pipe.getNode(i).getVelocityIn(phase).doubleValue();
            pipe.getNode(i).setVelocity(phase, meanVelocity);
            pipe.getNode(i).init();
        }
    }
    
    
    public void initTemperature(int phase){
        for(int i = 0;i<numberOfNodes;i++){
            pipe.getNode(i).init();
            pipe.getNode(i).getBulkSystem().setTemperature(pipe.getNode(i).getBulkSystem().getTemperature(phase) + 0.8 * diffMatrix.get(i,0)/(pipe.getNode(i).getBulkSystem().getPhases()[phase].getCp()/pipe.getNode(i).getBulkSystem().getPhases()[phase].getNumberOfMolesInPhase()/pipe.getNode(i).getBulkSystem().getPhases()[phase].getMolarMass()),phase);
            pipe.getNode(i).init();
        }
    }
    
    public void initPhaseFraction(int phase){
        for(int i = 0;i<numberOfNodes;i++){
            pipe.getNode(i).setPhaseFraction(phase, pipe.getNode(i).getPhaseFraction(phase)  + 0.8 * diffMatrix.get(i,0));
            pipe.getNode(i).setPhaseFraction(0, 1.0 - pipe.getNode(i).getPhaseFraction(phase));
            pipe.getNode(i).init();
        }
    }
    
    
    public void initComposition(int phase, int comp){
        for(int j = 0;j<numberOfNodes;j++){
            if((pipe.getNode(j).getBulkSystem().getPhases()[phase].getComponents()[comp].getx() + diffMatrix.get(j,0)*pipe.getNode(j).getBulkSystem().getPhases()[phase].getMolarMass()/pipe.getNode(j).getBulkSystem().getPhases()[phase].getComponents()[comp].getMolarMass())>1.0) {
                pipe.getNode(j).getBulkSystem().getPhases()[phase].getComponents()[comp].setx(1.0-1e-30);
            }
            else if(pipe.getNode(j).getBulkSystem().getPhases()[phase].getComponents()[comp].getx() + diffMatrix.get(j,0)*pipe.getNode(j).getBulkSystem().getPhases()[phase].getMolarMass()/pipe.getNode(j).getBulkSystem().getPhases()[phase].getComponents()[comp].getMolarMass()<0.0) {
                pipe.getNode(j).getBulkSystem().getPhases()[phase].getComponents()[comp].setx(1e-30);
            }
            else{
                pipe.getNode(j).getBulkSystem().getPhases()[phase].getComponents()[comp].setx(pipe.getNode(j).getBulkSystem().getPhases()[phase].getComponents()[comp].getx() + diffMatrix.get(j,0)*pipe.getNode(j).getBulkSystem().getPhases()[phase].getMolarMass()/pipe.getNode(j).getBulkSystem().getPhases()[phase].getComponents()[comp].getMolarMass());//pipe.getNode(j).getBulkSystem().getPhases()[0].getComponents()[p].getx() + 0.5*diff4Matrix[p].get(j,0));
            }
            
            double xSum=0.0;
            for(int i=0;i<pipe.getNode(j).getBulkSystem().getPhases()[phase].getNumberOfComponents()-1;i++){
                xSum += pipe.getNode(j).getBulkSystem().getPhases()[phase].getComponents()[i].getx();
            }
            
            pipe.getNode(j).getBulkSystem().getPhases()[phase].getComponents()[pipe.getNode(j).getBulkSystem().getPhases()[phase].getNumberOfComponents()-1].setx(1.0-xSum);
            pipe.getNode(j).init();
        }
    }
    
    
    
    public void initFinalResults(int phase){
        for(int i=0;i<numberOfNodes;i++){
            oldVelocity[phase][i] = pipe.getNode(i).getVelocityIn().doubleValue();
            oldDensity[phase][i] = pipe.getNode(i).getBulkSystem().getPhases()[0].getPhysicalProperties().getDensity();
            oldInternalEnergy[phase][i] = pipe.getNode(i).getBulkSystem().getPhases()[0].getEnthalpy()/pipe.getNode(i).getBulkSystem().getPhases()[0].getNumberOfMolesInPhase()/pipe.getNode(i).getBulkSystem().getPhases()[0].getMolarMass();
            
            for(int j=0;j<pipe.getNode(i).getBulkSystem().getPhases()[0].getNumberOfComponents();j++){
                oldComposition[phase][j][i] = xNew[phase][j][i];
            }
        }
    }
    
    public void calcFluxes(){
        for(int i=0;i<numberOfNodes;i++){
            pipe.getNode(i).calcFluxes();
        }
    }
    
    public void initNodes(){
        for(int i=0;i<numberOfNodes;i++){
            pipe.getNode(i).init();
        }
    }
    
    public void solveTDMA(){
        initProfiles();
    }
    
}
